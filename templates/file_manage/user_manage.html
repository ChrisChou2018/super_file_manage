{% extends "file_manage/base.html" %}

{% block css %}
<link rel="stylesheet" href="/static/file_manage/multiselect/css/multi-select.css">
{% endblock css %}

{% block content %}
<div class="modal fade" id="add_user_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">AddUser</h4>
            </div>
            <div class="modal-body">
                <form id="add_user_form">
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">UserName:</label>
                        <input type="text" class="form-control"  name="username">
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">Nicname:</label>
                        <input type="text" class="form-control"  name="first_name">
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">Password:</label>
                        <input type="password" class="form-control"  name="password1">
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">ConfirmPassword:</label>
                        <input type="password" class="form-control"  name="password2">
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">SuperUser:</label>
                        <button type="button" class="btn btn-danger super_user_button user_info_button">OF</button>
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">CanLogin:</label>
                        <button type="button" class="btn btn-danger can_login_button user_info_button">OF</button>
                    </div>
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">Permission:</label>
                        <select multiple="multiple" class="my_select" name="permission_list[]">
                        </select>
                    </div>
                    
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary submit_add_user">Enter</button>
            </div>
        </div>
    </div>
</div>


<div class="content-page">
    <!-- Start content -->
    <div class="content">
        <div class="row" >
            <div class="col-md-3" style="position:relative;overflow:auto;height:800px;top:10px;" >
                <div class="btn-group btn-group-justified" role="group" aria-label="Justified button group">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-default btn-success add_user_button"><span class="glyphicon glyphicon-plus"></span>AddUser</button>
                    </div>
                    <!-- <div class="btn-group" role="group">
                        <button type="button" class="btn btn-info"><span class="glyphicon glyphicon-new-window"></span>Move</button>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-warning select_all_button"><span class="glyphicon glyphicon-ok"></span>SelectAll</button>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary unselect_all_button"><span class="glyphicon glyphicon-ban-circle"></span>UnselectAll</button>
                    </div> -->
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-danger delete_user_button"><span class="glyphicon glyphicon-trash"></span>DeleteUser</button>
                    </div>
                </div>
                <h2>User</h2>
                <div class="list-group" id="user_data_list">
                    
                </div>
            </div>
            <div class="col-md-9">
                <h2>UserInfo</h2>
                <div class="user_info_box" style="display:none;">
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label for="recipient-name" class="control-label">UserName:</label>
                            <input type="text" name="id" old_data="" style="display:none">
                            <input type="text" class="form-control" old_data="" name="username" >
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label for="recipient-name" class="control-label">Nicname:</label>
                            <input type="text" class="form-control" old_data="" name="first_name">
                        </div>
                    </div>
                    
                    
                    <div class="row">
                        <div class="form-group col-md-3">
                            <label for="recipient-name" class="control-label">SuperUser:</label>
                            <button type="button" class="btn btn-danger super_user_button user_info_button " old_data="">OF</button>
                        </div>
                        <div class="form-group col-md-3">
                            <label for="recipient-name" class="control-label">CanLogin:</label>
                            <button type="button" class="btn btn-danger can_login_button user_info_button" old_data="">OF</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="recipient-name" class="control-label">Permission:</label>
                        <select multiple="multiple" class="my_select" name="permission_list[]">
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-info user_info_box_commit">Commit</button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
<script src="/static/file_manage/multiselect/js/jquery.multi-select.js" type="text/javascript"></script>
<script>
    
    $(function(){
        $('#page1').addClass('active')
        function init_user_table(){
            $.get(
                '/file_manage/api/request_user_list',
                function(data){
                    var data_list = data.data
                    $('#user_data_list').children().remove()
                    $('#user_data_list').append(data_list)
                    $('.user_item').click(function(){
                        $(this).siblings().removeClass('active')
                        $(this).addClass('active')
                        $.get(
                            '/file_manage/api/update_user',
                            {'user_id':$(this).attr('user_id')},
                            function(data){
                                $('.user_info_box').css('display','block')
                                var $input = $('.user_info_box input')
                                $input.each(function(index,ele){
                                    $(ele).val(data.data[$(ele).attr('name')])
                                    if($(ele).attr('name') != 'id'){
                                        $(ele).attr('old_data',data.data[$(ele).attr('name')])
                                    }
                                })
                                var is_super_user = data.data['is_superuser'] ? 'OP' : 'OF'
                                if(is_super_user == 'OP'){
                                    $('.user_info_box .super_user_button').removeClass('btn-danger')
                                    $('.user_info_box .super_user_button').addClass('btn-success')
                                    $('.user_info_box .super_user_button').text('OP')
                                    $('.user_info_box .super_user_button').attr('old_data','OP')
                                }else{
                                    $('.user_info_box .super_user_button').removeClass('btn-success')
                                    $('.user_info_box .super_user_button').addClass('btn-danger')
                                    $('.user_info_box .super_user_button').text('OF')
                                    $('.user_info_box .super_user_button').attr('old_data','OF')
                                }
                                var is_login = data.data['is_active'] ? 'OP' : 'OF'
                                if(is_login == 'OP'){
                                    $('.user_info_box .can_login_button').removeClass('btn-danger')
                                    $('.user_info_box .can_login_button').addClass('btn-success')
                                    $('.user_info_box .can_login_button').text('OP')
                                    $('.user_info_box .can_login_button').attr('old_data','OP')
                                }else{
                                    $('.user_info_box .can_login_button').removeClass('btn-success')
                                    $('.user_info_box .can_login_button').addClass('btn-danger')
                                    $('.user_info_box .can_login_button').text('OF')
                                    $('.user_info_box .can_login_button').attr('old_data','OF')
                                }
                                $('.user_info_box .my_select').multiSelect('deselect_all');
                                $('.user_info_box .my_select').multiSelect('select',data.permission_list)
                                $('.user_info_box_commit').click(function(){
                                    var $input = $('.user_info_box input')
                                    var formData = new FormData()
                                    $input.each(function(index,ele){
                                        if($(ele).attr('old_data')!=$(ele).val()){
                                            formData.append($(ele).attr('name'),$(ele).val())
                                        }
                                    })
                                    if($('.user_info_box .super_user_button').text()!=$('.user_info_box .super_user_button').attr('old_data')){
                                        var is_super_user = ($('.user_info_box .super_user_button').text()=='OP') ? true : false
                                        formData.append('is_superuser',is_super_user)
                                    }
                                    if($('.user_info_box .can_login_button').text()!=$('.user_info_box .can_login_button').attr('old_data')){
                                        var is_login = ($('.user_info_box .can_login_button').text()=='OP') ? true : false
                                        formData.append('is_active',is_login)
                                    }
                                    formData.append($('.user_info_box .my_select').attr('name'),$('.user_info_box .my_select').val())
                                    $.ajax({
                                        type:'post',
                                        url:'/file_manage/api/update_user',
                                        data:formData,
                                        dataType:'json',
                                        contentType:false,
                                        processData:false,
                                        success:function(data){
                                            if(data.return_code=='SUCCESS'){
                                                init_user_table()
                                            }else{
                                                $('#return_msg_box p').text(data.return_msg)
                                                $('#return_msg_box').modal()
                                            }
                                        }
                                    })
                                })

                            },
                            'json'
                        )
                    })
                },
                'json',
            )
        }
        $('.add_user_button').click(function(){
            $('#add_user_modal').modal()
            $('.submit_add_user').click(function(){
                var $form_input = $('#add_user_form input')
                var formData = new FormData();
                $form_input.each(function(index,ele){
                    formData.append($(ele).attr('name'), $(ele).val())
                })
                var $form_select = $('#add_user_form select')
                $form_select.each(function(index,ele){
                    formData.append($(ele).attr('name'), $(ele).val())
                })
                var super_user = $('.super_user_button').text()
                super_user = (super_user == 'OF') ? 0 : 1
                var can_login = $('.can_login_button').text()
                can_login = (can_login == 'OF') ? 0 : 1
                formData.append('is_super_user',super_user)
                formData.append('is_active',can_login)
                $.ajax({
                    type:'post',
                    url:'/file_manage/api/create_user',
                    data:formData,
                    dataType:'json',
                    contentType:false,
                    processData:false,
                    success:function(data){
                        if(data.return_code=='SUCCESS'){
                            init_user_table()
                        }else{
                            $('#return_msg_box p').text(data.return_msg)
                            $('#return_msg_box').modal()
                        }
                    }
                })
            })
        })
        $('.delete_user_button').click(function(){
            var user_item = null
            $('.user_item').each(function(index,ele){
                if($(ele).hasClass('active')){
                    user_item = ele
                }
                
            })
            $.post(
                '/file_manage/api/delete_user',
                {'user_id':$(user_item).attr('user_id')},
                function(data){
                    if(data.return_code=='SUCCESS'){
                        init_user_table()
                        $('.user_info_box').css('display','none')
                    }else{
                        $('#return_msg_box p').text(data.return_msg)
                        $('#return_msg_box').modal()
                    }
                },
                'json',
            )
        })
        function init_permission_list(){
            $.get(
                '/file_manage/api/request_permission_list',
                function(data){
                    var value_data = data.data
                    $('.my_select').multiSelect()
                    for(var i=0;i<value_data.length;i++){
                        $('.my_select').multiSelect('addOption', value_data[i])
                    }
                    $('.user_info_button').click(function(){
                        if($(this).text()=='OF'){
                            $(this).removeClass('btn-danger')
                            $(this).addClass('btn-success')
                            $(this).text('OP')
                        }else{
                            $(this).removeClass('btn-success')
                            $(this).addClass('btn-danger')
                            $(this).text('OF')
                        }
                    })
                },
                'json',
            )
            
        }
        function init_page(){
            init_user_table()
            init_permission_list()
        }
        init_page()
    })
</script>
{% endblock js %}